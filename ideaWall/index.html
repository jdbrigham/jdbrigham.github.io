<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Idea Wall</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --linen:#f5f0e8;--linen-dark:#e8e0d0;
  --ink:#1a1610;--ink-faint:#6b5f4a;--ink-ghost:#a89880;
  --accent:#c84b2f;--shadow:rgba(30,20,10,.18);
  --card-idea:#fffdf5;--card-note:#edf2fb;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--linen);font-family:'Courier Prime',monospace;color:var(--ink);user-select:none}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='400' height='400' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E")}
#wall-view,#capture-view{position:fixed;inset:0;z-index:1;transition:opacity .3s ease,transform .3s ease}
#capture-view{opacity:0;pointer-events:none;transform:translateY(20px);background:var(--linen);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;z-index:200}
body.capture-mode #wall-view{opacity:0;pointer-events:none;transform:translateY(-12px)}
body.capture-mode #topbar{opacity:0;pointer-events:none}
body.capture-mode #capture-view{opacity:1;pointer-events:all;transform:none}
#topbar{position:fixed;top:0;left:0;right:0;z-index:100;height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 1.5rem;background:linear-gradient(to bottom,rgba(245,240,232,.98) 60%,rgba(245,240,232,0));pointer-events:none;transition:opacity .3s ease}
#topbar>*{pointer-events:all}
.wordmark{font-family:'Playfair Display',serif;font-size:1.1rem;letter-spacing:.02em;color:var(--ink);opacity:.85}
.wordmark em{font-style:italic;color:var(--accent)}
.topbar-right{display:flex;align-items:center;gap:.6rem}
.btn-sep{width:1px;height:20px;background:var(--linen-dark);margin:0 .05rem}
.btn-icon{width:36px;height:36px;border-radius:50%;border:1.5px solid var(--linen-dark);background:rgba(245,240,232,.9);color:var(--ink-faint);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s ease;backdrop-filter:blur(4px)}
.btn-icon:hover{background:var(--ink);color:var(--linen);border-color:var(--ink)}
.btn-icon.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 0 0 3px rgba(200,75,47,.18)}
.btn-icon svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}
#zoom-controls{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);z-index:100;display:flex;align-items:center;gap:.5rem;background:rgba(245,240,232,.92);border:1.5px solid var(--linen-dark);border-radius:2rem;padding:.35rem .75rem;backdrop-filter:blur(6px);box-shadow:0 4px 20px rgba(30,20,10,.1);transition:opacity .25s}
body.connect-mode #zoom-controls{opacity:.35;pointer-events:none}
.zoom-btn{width:28px;height:28px;border:none;background:none;cursor:pointer;color:var(--ink-faint);font-size:1.2rem;line-height:1;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .15s}
.zoom-btn:hover{color:var(--ink);background:var(--linen-dark)}
#zoom-label{font-family:'Courier Prime',monospace;font-size:.7rem;color:var(--ink-ghost);width:2.8rem;text-align:center;letter-spacing:.05em}
.zoom-pip{width:6px;height:6px;border-radius:50%;background:var(--linen-dark);cursor:pointer;transition:background .15s}
.zoom-pip.active{background:var(--accent)}
#connect-hint{position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:101;background:var(--ink);color:var(--linen);font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;padding:.4rem 1.2rem;border-radius:2rem;opacity:0;pointer-events:none;transition:opacity .2s;white-space:nowrap}
body.connect-mode #connect-hint{opacity:1}
#canvas-wrap{position:fixed;inset:0;overflow:hidden;z-index:2;cursor:grab}
#canvas-wrap.panning{cursor:grabbing}
#canvas-wrap.card-dragging{cursor:grabbing}
body.connect-mode #canvas-wrap{cursor:crosshair}
#canvas{position:absolute;width:4000px;height:3000px;top:50%;left:50%;transform-origin:center center}
#connector-svg{position:absolute;top:0;left:0;width:100%;height:100%;overflow:visible;z-index:1;pointer-events:none}
.conn-line{stroke:var(--ink-faint);stroke-width:1.5;opacity:.5;pointer-events:none}
.conn-dot{fill:var(--ink-faint);opacity:.5;pointer-events:none}
.conn-hit{stroke:transparent;stroke-width:14;fill:none;cursor:pointer;pointer-events:stroke}
.conn-g{pointer-events:all}
.conn-g:hover .conn-line{opacity:1;stroke:var(--accent)}
.conn-g:hover .conn-dot{opacity:1;fill:var(--accent)}
#preview-line{stroke:var(--accent);stroke-width:1.5;stroke-dasharray:5 4;opacity:.65;pointer-events:none}
#preview-dot{fill:var(--accent);opacity:.8;pointer-events:none}
#empty-state{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;opacity:.4}
#empty-state .es-big{font-family:'Playfair Display',serif;font-size:5rem;opacity:.3;line-height:1}
#empty-state p{font-size:.85rem;color:var(--ink-faint);margin-top:.5rem;letter-spacing:.05em}
#empty-state.hidden{display:none}
.idea-card{position:absolute;border-radius:2px;box-shadow:0 2px 4px var(--shadow),0 8px 24px rgba(30,20,10,.08),inset 0 0 0 1px rgba(30,20,10,.06);padding:1rem 1rem .75rem;cursor:grab;display:flex;flex-direction:column;gap:.45rem;transition:box-shadow .2s ease,transform .2s ease,outline .12s}
.idea-card:hover{box-shadow:0 4px 8px var(--shadow),0 16px 40px rgba(30,20,10,.14),inset 0 0 0 1px rgba(30,20,10,.08)}
.idea-card.dragging{cursor:grabbing;box-shadow:0 12px 30px rgba(30,20,10,.25),0 4px 8px var(--shadow),inset 0 0 0 1px rgba(30,20,10,.08);transform:rotate(0deg) scale(1.04)!important;z-index:999!important;transition:box-shadow .1s ease}
.idea-card::before{content:'';position:absolute;top:-8px;left:50%;transform:translateX(-50%);width:40px;height:16px;background:rgba(200,75,47,.12);border-radius:1px}
.card-idea{background:var(--card-idea);width:220px;min-height:140px}
.card-note{background:var(--card-note);width:184px;min-height:108px;box-shadow:0 2px 4px var(--shadow),0 6px 16px rgba(30,20,10,.07),inset 0 0 0 1px rgba(70,100,180,.09)}
.card-note::before{background:rgba(70,100,200,.1)}
body.connect-mode .idea-card{cursor:pointer}
body.connect-mode .idea-card:hover{outline:2px solid var(--accent);outline-offset:3px;box-shadow:0 0 0 5px rgba(200,75,47,.1),0 8px 24px rgba(30,20,10,.12);z-index:50!important}
.idea-card.connect-sel{outline:2.5px solid var(--accent)!important;outline-offset:3px;box-shadow:0 0 0 6px rgba(200,75,47,.15),0 8px 24px rgba(30,20,10,.14)!important}
.card-type-label{font-size:.58rem;letter-spacing:.13em;text-transform:uppercase;color:var(--ink-ghost);opacity:.8;user-select:none}
.card-note .card-type-label{color:#6888bb;opacity:.8}
.card-title{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:600;color:var(--ink);line-height:1.3;outline:none;border:none;background:none;width:100%;resize:none;cursor:text;min-height:1.3em}
.card-note .card-title{font-size:.86rem}
.card-body{font-size:.78rem;color:var(--ink-faint);line-height:1.55;outline:none;border:none;background:none;width:100%;resize:none;cursor:text;min-height:2.5em;font-family:'Courier Prime',monospace}
.card-note .card-body{font-size:.73rem}
.card-title:focus,.card-body:focus{background:rgba(30,20,10,.02);border-radius:2px}
body.connect-mode .card-title,body.connect-mode .card-body{pointer-events:none}
.card-tags{display:flex;flex-wrap:wrap;gap:.25rem}
.tag-pill{font-size:.57rem;letter-spacing:.06em;text-transform:uppercase;padding:.14rem .44rem;border-radius:2rem;background:rgba(30,20,10,.07);color:var(--ink-faint);user-select:none;line-height:1.6}
.card-note .tag-pill{background:rgba(70,100,200,.1);color:#5070a8}
.card-footer{display:flex;align-items:center;justify-content:space-between;margin-top:auto;padding-top:.45rem;border-top:1px solid rgba(30,20,10,.06)}
.card-note .card-footer{border-top-color:rgba(70,100,200,.1)}
.card-date{font-size:.58rem;color:var(--ink-ghost);letter-spacing:.05em}
.card-actions{display:flex;align-items:center;gap:.15rem}
.card-btn{width:18px;height:18px;border:none;background:none;cursor:pointer;color:var(--ink-ghost);border-radius:3px;display:flex;align-items:center;justify-content:center;opacity:0;transition:all .15s;padding:0;flex-shrink:0}
.idea-card:hover .card-btn{opacity:1}
.card-btn:hover{background:var(--linen-dark);color:var(--ink-faint)}
.card-btn.del:hover{background:#fee2de;color:var(--accent)}
.card-btn svg{width:11px;height:11px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
body.connect-mode .card-btn{display:none}
.tag-popover{position:fixed;z-index:1000;background:#fff;border:1.5px solid var(--linen-dark);border-radius:6px;padding:.65rem .75rem;box-shadow:0 8px 30px rgba(30,20,10,.15);min-width:158px;max-width:210px;display:none}
.tag-popover.open{display:block}
.tag-popover-title{font-size:.58rem;letter-spacing:.12em;text-transform:uppercase;color:var(--ink-ghost);margin-bottom:.5rem}
.tag-popover-empty{font-size:.72rem;color:var(--ink-ghost);font-style:italic;line-height:1.5}
.tag-option{display:flex;align-items:center;gap:.45rem;padding:.28rem .2rem;cursor:pointer;border-radius:3px;transition:background .1s}
.tag-option:hover{background:var(--linen)}
.tag-check{width:13px;height:13px;border:1.5px solid var(--linen-dark);border-radius:2px;flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .12s}
.tag-check.on{background:var(--accent);border-color:var(--accent)}
.tag-check.on::after{content:'✓';font-size:.55rem;color:#fff;line-height:1}
.tag-option-label{font-size:.72rem;color:var(--ink-faint)}
#tag-manager{position:fixed;inset:0;z-index:500;background:rgba(26,22,16,.35);backdrop-filter:blur(3px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s}
#tag-manager.open{opacity:1;pointer-events:all}
.tm-box{background:var(--linen);border:1.5px solid var(--linen-dark);border-radius:6px;padding:1.5rem;width:300px;box-shadow:0 16px 50px rgba(30,20,10,.2)}
.tm-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem}
.tm-title{font-family:'Playfair Display',serif;font-size:1rem;color:var(--ink)}
.tm-close{width:24px;height:24px;border:none;background:none;cursor:pointer;color:var(--ink-ghost);font-size:1.1rem;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all .12s}
.tm-close:hover{background:var(--linen-dark);color:var(--ink)}
.tm-list{display:flex;flex-direction:column;gap:.35rem;margin-bottom:.9rem;min-height:20px}
.tm-tag-row{display:flex;align-items:center;justify-content:space-between;padding:.3rem .5rem;border-radius:4px;background:rgba(30,20,10,.04)}
.tm-tag-name{font-size:.78rem;color:var(--ink-faint)}
.tm-del-tag{border:none;background:none;cursor:pointer;color:var(--ink-ghost);font-size:.9rem;line-height:1;border-radius:3px;padding:.1rem .3rem;transition:all .12s}
.tm-del-tag:hover{background:#fee2de;color:var(--accent)}
.tm-empty{font-size:.75rem;color:var(--ink-ghost);font-style:italic;text-align:center;padding:.5rem 0}
.tm-add{display:flex;gap:.5rem}
.tm-input{flex:1;font-family:'Courier Prime',monospace;font-size:.82rem;border:1.5px solid var(--linen-dark);border-radius:3px;padding:.45rem .65rem;outline:none;background:#fff;color:var(--ink);transition:border-color .15s}
.tm-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(200,75,47,.08)}
.tm-add-btn{padding:.45rem .85rem;background:var(--ink);color:var(--linen);border:none;border-radius:3px;font-family:'Courier Prime',monospace;font-size:.78rem;letter-spacing:.06em;cursor:pointer;transition:all .15s}
.tm-add-btn:hover{background:var(--accent)}
#card-count{position:fixed;top:.55rem;left:50%;transform:translateX(-50%);z-index:101;font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:var(--ink-ghost);pointer-events:none;transition:opacity .25s}
body.connect-mode #card-count{opacity:0}
.capture-inner{width:100%;max-width:400px}
.capture-header{margin-bottom:2rem}
.capture-header h1{font-family:'Playfair Display',serif;font-size:1.8rem;color:var(--ink)}
.capture-header h1 em{color:var(--accent);font-style:italic}
.capture-header p{font-size:.78rem;color:var(--ink-ghost);margin-top:.25rem;letter-spacing:.04em}
.capture-form{display:flex;flex-direction:column;gap:1rem}
.field{display:flex;flex-direction:column;gap:.35rem}
.field label{font-size:.65rem;letter-spacing:.14em;text-transform:uppercase;color:var(--ink-ghost)}
.field input,.field textarea{font-family:'Courier Prime',monospace;font-size:.95rem;color:var(--ink);background:#fff;border:1.5px solid var(--linen-dark);border-radius:3px;padding:.65rem .85rem;outline:none;transition:border-color .15s;resize:none}
.field input:focus,.field textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(200,75,47,.08)}
.field textarea{min-height:120px;line-height:1.5}
.capture-actions{display:flex;gap:.75rem;margin-top:.5rem}
.btn-primary{flex:1;padding:.8rem;background:var(--ink);color:var(--linen);border:none;border-radius:3px;font-family:'Courier Prime',monospace;font-size:.85rem;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:all .15s}
.btn-primary:hover{background:var(--accent)}
.btn-ghost{padding:.8rem 1.2rem;background:none;color:var(--ink-faint);border:1.5px solid var(--linen-dark);border-radius:3px;font-family:'Courier Prime',monospace;font-size:.85rem;cursor:pointer;transition:all .15s}
.btn-ghost:hover{border-color:var(--ink-faint);color:var(--ink)}
#toast{position:fixed;bottom:5rem;left:50%;transform:translateX(-50%);background:var(--ink);color:var(--linen);font-size:.75rem;letter-spacing:.06em;padding:.5rem 1.2rem;border-radius:2rem;z-index:9999;opacity:0;pointer-events:none;transition:opacity .2s;font-family:'Courier Prime',monospace;white-space:nowrap}
#toast.show{opacity:1}
#sync-status{font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--ink-ghost);display:flex;align-items:center;gap:.35rem;transition:opacity .3s}
#sync-status.hidden{opacity:0}
.sync-dot{width:5px;height:5px;border-radius:50%;background:var(--ink-ghost);flex-shrink:0;transition:background .3s}
#sync-status.syncing .sync-dot{background:#c8931a;animation:pulse .8s ease-in-out infinite}
#sync-status.synced .sync-dot{background:#4a9e6b}
#sync-status.error .sync-dot{background:var(--accent)}
#sync-status.error{color:var(--accent)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}

/* Setup modal */
#setup-modal{position:fixed;inset:0;z-index:9000;background:var(--linen);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:2rem;opacity:0;pointer-events:none;transition:opacity .3s}
#setup-modal.open{opacity:1;pointer-events:all}
.setup-box{width:100%;max-width:420px}
.setup-header{margin-bottom:2rem}
.setup-header h1{font-family:'Playfair Display',serif;font-size:1.6rem;color:var(--ink)}
.setup-header h1 em{color:var(--accent);font-style:italic}
.setup-header p{font-size:.78rem;color:var(--ink-ghost);margin-top:.4rem;line-height:1.6;letter-spacing:.02em}
.setup-header a{color:var(--accent);text-decoration:none}
.setup-header a:hover{text-decoration:underline}
.setup-form{display:flex;flex-direction:column;gap:.9rem}
.setup-field{display:flex;flex-direction:column;gap:.35rem}
.setup-field label{font-size:.65rem;letter-spacing:.14em;text-transform:uppercase;color:var(--ink-ghost)}
.setup-field input{font-family:'Courier Prime',monospace;font-size:.88rem;color:var(--ink);background:#fff;border:1.5px solid var(--linen-dark);border-radius:3px;padding:.65rem .85rem;outline:none;transition:border-color .15s;letter-spacing:.03em}
.setup-field input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(200,75,47,.08)}
.setup-field .hint{font-size:.65rem;color:var(--ink-ghost);margin-top:.2rem;letter-spacing:.02em}
.setup-actions{display:flex;gap:.75rem;margin-top:.5rem}
.setup-save{flex:1;padding:.8rem;background:var(--ink);color:var(--linen);border:none;border-radius:3px;font-family:'Courier Prime',monospace;font-size:.85rem;letter-spacing:.08em;text-transform:uppercase;cursor:pointer;transition:all .15s}
.setup-save:hover{background:var(--accent)}
.setup-skip{padding:.8rem 1.2rem;background:none;color:var(--ink-ghost);border:1.5px solid var(--linen-dark);border-radius:3px;font-family:'Courier Prime',monospace;font-size:.85rem;cursor:pointer;transition:all .15s}
.setup-skip:hover{border-color:var(--ink-faint);color:var(--ink)}
.setup-error{font-size:.72rem;color:var(--accent);margin-top:.15rem;display:none}
.setup-error.show{display:block}

.capture-feedback{font-family:'Courier Prime',monospace;font-size:.82rem;letter-spacing:.04em;
  text-align:center;padding:.6rem;border-radius:4px;margin-top:.5rem;
  opacity:0;transform:translateY(-4px);transition:opacity .25s ease,transform .25s ease;pointer-events:none}
.capture-feedback.show{opacity:1;transform:none}
.capture-feedback.success{color:#3a7a57;background:rgba(58,122,87,.08)}
.capture-feedback.error{color:var(--accent);background:rgba(200,75,47,.07)}

/* Checklist on note cards */
.card-checklist{display:flex;flex-direction:column;gap:.28rem;margin-top:.1rem}
.checklist-item{display:flex;align-items:flex-start;gap:.45rem;cursor:default}
.checklist-item input[type=checkbox]{
  width:12px;height:12px;margin-top:.18em;flex-shrink:0;cursor:pointer;
  accent-color:var(--accent);border-radius:2px}
.checklist-item-text{
  font-size:.73rem;color:var(--ink-faint);line-height:1.45;
  font-family:'Courier Prime',monospace;flex:1;
  outline:none;border:none;background:none;resize:none;cursor:text;
  min-width:0;padding:0;min-height:1.45em;height:auto;
  display:block;width:100%}
.checklist-item-text:focus{background:rgba(30,20,10,.02);border-radius:2px}
.checklist-item.done .checklist-item-text{text-decoration:line-through;opacity:.5}
.checklist-item input[type=checkbox]{pointer-events:all}
body.connect-mode .checklist-item input[type=checkbox]{pointer-events:none}
.checklist-add-row{display:flex;align-items:center;gap:.4rem;margin-top:.1rem}
.checklist-add-btn{
  font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--ink-ghost);background:none;border:none;cursor:pointer;
  padding:.1rem 0;font-family:'Courier Prime',monospace;
  opacity:0;transition:opacity .15s}
.card-note:hover .checklist-add-btn{opacity:1}
.checklist-add-btn:hover{color:var(--accent)}
.checklist-toggle-btn{
  font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--ink-ghost);background:none;border:none;cursor:pointer;
  padding:.1rem 0;font-family:'Courier Prime',monospace;
  opacity:0;transition:opacity .15s;margin-left:auto}
.card-note:hover .checklist-toggle-btn{opacity:.7}
.checklist-toggle-btn:hover{color:var(--ink-faint);opacity:1!important}

.btn-add-card{
  width:auto !important;
  border-radius:2rem !important;
  padding:0 .75rem 0 .55rem !important;
  gap:.3rem;
  font-family:'Courier Prime',monospace;
  font-size:.68rem;
  letter-spacing:.08em;
  text-transform:uppercase;
}
.btn-add-card span{line-height:1}

/* Link card */
.card-link-type{
  background:#fafaf8;
  width:220px;
  min-height:80px;
  cursor:pointer;
  text-decoration:none;
  color:inherit;
}
.card-link-type::before{background:rgba(30,20,10,.08)}
.card-link-type:hover{
  box-shadow:0 4px 8px var(--shadow),0 16px 40px rgba(30,20,10,.14),inset 0 0 0 1px rgba(30,20,10,.12);
}
.card-link-preview{
  width:100%;aspect-ratio:16/9;border-radius:2px;
  background:var(--linen-dark);
  overflow:hidden;display:flex;align-items:center;justify-content:center;
  margin-bottom:.3rem;flex-shrink:0;
}
.card-link-preview img{width:100%;height:100%;object-fit:cover;display:block}
.card-link-preview-placeholder{
  font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--ink-ghost);display:flex;flex-direction:column;align-items:center;gap:.4rem;
}
.card-link-preview-placeholder svg{width:20px;height:20px;stroke:var(--ink-ghost);fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;opacity:.5}
.card-link-title{
  font-family:'Playfair Display',serif;font-size:.9rem;font-weight:600;
  color:var(--ink);line-height:1.3;
}
.card-link-domain{
  font-size:.6rem;letter-spacing:.06em;color:var(--ink-ghost);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  display:flex;align-items:center;gap:.25rem;margin-top:.25rem;
}
.card-link-domain::before{content:'↗';font-size:.65rem;color:var(--accent)}
.card-link-type-label{
  font-size:.58rem;letter-spacing:.13em;text-transform:uppercase;
  color:var(--ink-ghost);opacity:.6;user-select:none;margin-bottom:.1rem;
}

/* Link popover */
.link-popover{
  position:fixed;z-index:500;
  background:var(--linen);border:1.5px solid var(--linen-dark);border-radius:6px;
  padding:.9rem 1rem;box-shadow:0 8px 30px rgba(30,20,10,.15);
  width:280px;display:none;
}
.link-popover.open{display:block}
.link-popover-title{
  font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;
  color:var(--ink-ghost);margin-bottom:.75rem;
}
.link-popover-fields{display:flex;flex-direction:column;gap:.6rem}
.link-field{display:flex;flex-direction:column;gap:.25rem}
.link-field label{
  font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:var(--ink-ghost);
  display:flex;align-items:center;gap:.35rem;
}
.link-field-hint{font-size:.58rem;letter-spacing:.06em;opacity:.7;text-transform:none}
.link-field input{
  font-family:'Courier Prime',monospace;font-size:.78rem;color:var(--ink);
  background:#fff;border:1.5px solid var(--linen-dark);border-radius:3px;
  padding:.4rem .6rem;outline:none;transition:border-color .15s;
}
.link-field input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(200,75,47,.08)}
.link-popover-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.8rem}
.lp-cancel{
  padding:.4rem .7rem;background:none;border:1.5px solid var(--linen-dark);
  border-radius:3px;font-family:'Courier Prime',monospace;font-size:.72rem;
  color:var(--ink-ghost);cursor:pointer;transition:all .15s;
}
.lp-cancel:hover{border-color:var(--ink-faint);color:var(--ink)}
.lp-add{
  padding:.4rem .8rem;background:var(--ink);color:var(--linen);
  border:none;border-radius:3px;font-family:'Courier Prime',monospace;
  font-size:.72rem;letter-spacing:.06em;cursor:pointer;transition:all .15s;
}
.lp-add:hover{background:var(--accent)}

/* ── Groups ── */
.group-box{
  position:absolute;border-radius:4px;
  border:2.5px dashed rgba(30,20,10,.32);
  background:rgba(30,20,10,.03);
  cursor:move; z-index:1;
  box-sizing:border-box;
  min-width:120px;min-height:80px;
}
.group-box:hover{ border-color:rgba(30,20,10,.55); }
.group-box.selected{ border-color:var(--accent); border-style:solid; }
.group-label{
  position:absolute;top:8px;left:10px;
  font-size:.62rem;letter-spacing:.12em;text-transform:uppercase;
  color:var(--ink-ghost);font-family:'Courier Prime',monospace;
  background:none;border:none;outline:none;cursor:text;
  max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  pointer-events:all;
}
.group-label:focus{
  color:var(--ink-faint);
  background:rgba(245,240,232,.9);padding:0 3px;border-radius:2px;
}
/* resize handle — bottom-right corner */
.group-resize{
  position:absolute;bottom:0;right:0;
  width:16px;height:16px;cursor:se-resize;
  display:flex;align-items:flex-end;justify-content:flex-end;
  padding:3px;opacity:0;transition:opacity .15s;
}
.group-box:hover .group-resize{ opacity:1; }
.group-resize svg{
  width:8px;height:8px;stroke:var(--ink-ghost);fill:none;
  stroke-width:1.8;stroke-linecap:round;
}
/* delete group button */
.group-del{
  position:absolute;top:5px;right:6px;
  width:16px;height:16px;border:none;background:none;
  cursor:pointer;color:var(--ink-ghost);border-radius:2px;
  display:flex;align-items:center;justify-content:center;
  opacity:0;transition:opacity .15s;padding:0;
}
.group-box:hover .group-del{ opacity:.7; }
.group-del:hover{ opacity:1!important;color:var(--accent); }
.group-del svg{width:9px;height:9px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;}

/* ── Minimap ── */
#minimap{
  position:fixed;bottom:5.5rem;right:1.25rem;z-index:200;
  width:168px;height:112px;
  background:rgba(245,240,232,.95);
  border:1.5px solid var(--linen-dark);border-radius:5px;
  box-shadow:0 4px 18px rgba(30,20,10,.12);
  overflow:hidden;cursor:pointer;
  transition:opacity .2s;
}
#minimap:hover{ border-color:var(--ink-ghost); }
#minimap-canvas{ width:100%;height:100%;display:block; }
#minimap-toggle{
  position:fixed;bottom:5.5rem;right:1.25rem;z-index:201;
  width:28px;height:28px;border-radius:50%;
  border:1.5px solid var(--linen-dark);
  background:rgba(245,240,232,.9);color:var(--ink-ghost);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all .15s;backdrop-filter:blur(4px);
  font-size:.55rem;letter-spacing:.06em;text-transform:uppercase;
  font-family:'Courier Prime',monospace;
}
#minimap-toggle:hover{background:var(--ink);color:var(--linen);border-color:var(--ink);}
body.minimap-hidden #minimap{ display:none; }
body.minimap-hidden #minimap-toggle{ display:flex; }
body:not(.minimap-hidden) #minimap-toggle{ display:none; }
</style>
</head>
<body>
<div id="topbar">
  <div class="wordmark"><em>idea</em> wall</div>
  <div id="card-count"></div>
  <div id="sync-status" class="hidden"><div class="sync-dot"></div><span id="sync-label">–</span></div>
  <button class="btn-icon" id="btn-setup" title="Gist sync settings" style="width:28px;height:28px;opacity:.55">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
  </button>
  <div class="topbar-right">
    <button class="btn-icon" id="btn-tags" title="Manage tags (T)">
      <svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
    </button>
    <button class="btn-icon" id="btn-add-group" title="Add group">
      <svg viewBox="0 0 24 24"><rect x="2" y="3" width="20" height="18" rx="2"/><line x1="2" y1="8" x2="22" y2="8"/><line x1="6" y1="5.5" x2="6" y2="5.6"/></svg>
    </button>
    <div class="btn-sep"></div>
    <button class="btn-icon" id="btn-connect" title="Connect cards (C)">
      <svg viewBox="0 0 24 24"><circle cx="5" cy="12" r="2.2" stroke-width="1.8"/><circle cx="19" cy="12" r="2.2" stroke-width="1.8"/><line x1="7.2" y1="12" x2="16.8" y2="12"/></svg>
    </button>
    <div class="btn-sep"></div>
    <button class="btn-icon" id="btn-add-note" title="Add note card">
      <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="8" y1="9" x2="16" y2="9"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="12" y2="17"/></svg>
    </button>
    <button class="btn-icon" id="btn-add-link" title="Add link card">
      <svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>
    </button>
    <button class="btn-icon btn-add-card" id="btn-add" title="Add idea card (N)">
      <svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      <span>new</span>
    </button>
  </div>
</div>
<div id="connect-hint">click two cards to connect · click a line to remove · esc to exit</div>
<div id="wall-view">
  <div id="canvas-wrap">
    <div id="canvas">
      <svg id="connector-svg" xmlns="http://www.w3.org/2000/svg">
        <line id="preview-line" x1="0" y1="0" x2="0" y2="0" display="none"/>
        <circle id="preview-dot" cx="0" cy="0" r="3.5" display="none"/>
      </svg>
      <div id="empty-state">
        <div class="es-big">✦</div>
        <p>your wall is empty<br>press + to add an idea</p>
      </div>
    </div>
  </div>
  <div id="zoom-controls">
    <button class="zoom-btn" id="btn-zoom-out">−</button>
    <div class="zoom-pip" data-level="0"></div>
    <div class="zoom-pip" data-level="1"></div>
    <div class="zoom-pip active" data-level="2"></div>
    <div class="zoom-pip" data-level="3"></div>
    <div class="zoom-pip" data-level="4"></div>
    <span id="zoom-label">100%</span>
    <button class="zoom-btn" id="btn-zoom-in">+</button>
  </div>
</div>
<div id="tag-manager">
  <div class="tm-box">
    <div class="tm-header">
      <span class="tm-title">manage tags</span>
      <button class="tm-close" id="tm-close">×</button>
    </div>
    <div class="tm-list" id="tm-list"></div>
    <div class="tm-add">
      <input class="tm-input" id="tm-input" placeholder="new tag…" maxlength="24" autocomplete="off">
      <button class="tm-add-btn" id="tm-add-btn">add</button>
    </div>
  </div>
</div>
<div class="tag-popover" id="tag-popover">
  <div class="tag-popover-title">apply tags</div>
  <div id="tag-popover-list"></div>
</div>
<div id="capture-view">
  <div class="capture-inner">
    <div class="capture-header">
      <h1>capture an <em>idea</em></h1>
      <p>add a card to the wall</p>
    </div>
    <div class="capture-form">
      <div class="field">
        <label>Title</label>
        <input type="text" id="cap-title" placeholder="the idea in a few words…" autocomplete="off" autocorrect="off">
      </div>
      <div class="field">
        <label>Notes</label>
        <textarea id="cap-body" placeholder="expand on the thought…"></textarea>
      </div>
      <div class="capture-actions">
        <button class="btn-ghost" id="btn-cancel-capture">← wall</button>
        <button class="btn-primary" id="btn-submit-capture">add to wall →</button>
      </div>
      <div class="capture-feedback" id="capture-feedback"></div>
    </div>
  </div>
</div>
<div id="toast"></div>
<!-- Setup modal -->
<div id="setup-modal">
  <div class="setup-box">
    <div class="setup-header">
      <h1>connect to <em>gist</em></h1>
      <p>Enter your GitHub credentials to sync cards across devices. These are stored only in your browser — never in the file itself.<br><br>
      Need help? <a href="https://gist.github.com" target="_blank">Create a secret gist</a> with a file named <code>idea-wall-data.json</code> containing <code>{}</code>, then <a href="https://github.com/settings/tokens" target="_blank">generate a token</a> with only the <strong>gist</strong> scope.</p>
    </div>
    <div class="setup-form">
      <div class="setup-field">
        <label>Gist ID</label>
        <input type="text" id="setup-gist-id" placeholder="e.g. a1b2c3d4e5f6…" autocomplete="off" spellcheck="false">
        <div class="hint">The long hash in your Gist URL — not the filename</div>
      </div>
      <div class="setup-field">
        <label>GitHub Token</label>
        <input type="password" id="setup-gist-token" placeholder="ghp_…" autocomplete="off" spellcheck="false">
        <div class="hint">Personal access token with <strong>gist</strong> scope only</div>
      </div>
      <div class="setup-error" id="setup-error">Please enter both a Gist ID and a token.</div>
      <div class="setup-actions">
        <button class="setup-skip" id="setup-skip">skip for now</button>
        <button class="setup-save" id="setup-save">save &amp; connect →</button>
      </div>
    </div>
  </div>
</div>
<!-- Link card popover -->
<div class="link-popover" id="link-popover">
  <div class="link-popover-title">add link card</div>
  <div class="link-popover-fields">
    <div class="link-field">
      <label>URL</label>
      <input type="url" id="lp-url" placeholder="https://…" autocomplete="off" spellcheck="false">
    </div>
    <div class="link-field">
      <label>Title</label>
      <input type="text" id="lp-title" placeholder="page title…" autocomplete="off">
    </div>
    <div class="link-field">
      <label>Preview image URL <span class="link-field-hint">optional</span></label>
      <input type="url" id="lp-image" placeholder="https://…/image.jpg" autocomplete="off" spellcheck="false">
    </div>
  </div>
  <div class="link-popover-actions">
    <button class="lp-cancel">cancel</button>
    <button class="lp-add">add card →</button>
  </div>
</div>
<!-- Minimap -->
<div id="minimap"><canvas id="minimap-canvas"></canvas></div>
<button id="minimap-toggle" title="Show minimap">map</button>
<script>
const ZOOM_LEVELS=[0.35,0.6,1.0,1.45,2.0];
const ZOOM_LABELS=['35%','60%','100%','145%','200%'];
const ROTATIONS=[-2.5,-1.5,-0.8,0,0.8,1.5,2.5];
const CX=2000,CY=1500;
let cards=[],connectors=[],tags=[],groups=[];
let zoomIndex=2,panX=0,panY=0,isPanning=false,panSX=0,panSY=0,panOX=0,panOY=0;
let connectMode=false,connectFirst=null,popoverCardId=null;

// ═══════════════════════════════════════
// GIST SYNC CONFIG — fill these in
// ═══════════════════════════════════════
const GIST_FILE = 'idea-wall-data.json';
function getConfig(){ return {id:localStorage.getItem('iw-gist-id')||'', token:localStorage.getItem('iw-gist-token')||''}; }
function isConfigured(){ const c=getConfig(); return c.id.length>10&&c.token.length>10; }

// Sync status UI
const syncEl    = document.getElementById('sync-status');
const syncLabel = document.getElementById('sync-label');
function setSyncStatus(state, text){
  syncEl.className = state === 'hidden' ? 'hidden' : '';
  if(state !== 'hidden') syncEl.classList.add(state);
  syncLabel.textContent = text;
}

// Debounce for saves — wait 1.2s after last change before writing to Gist
let saveTimer = null;
function save(){
  // Always write to localStorage as immediate local backup
  try{localStorage.setItem('iw-cards',      JSON.stringify(cards));     }catch(e){}
  try{localStorage.setItem('iw-connectors', JSON.stringify(connectors));}catch(e){}
  try{localStorage.setItem('iw-tags',       JSON.stringify(tags));      }catch(e){}
  if(!isConfigured()) return;
  clearTimeout(saveTimer);
  setSyncStatus('syncing','saving…');
  saveTimer = setTimeout(pushToGist, 1200);
}

async function pushToGist(){
  const data = {cards, connectors, tags, groups};
  try{
    const res = await fetch('https://api.github.com/gists/'+getConfig().id, {
      method: 'PATCH',
      headers: {
        'Authorization': 'token '+getConfig().token,
        'Content-Type':  'application/json'
      },
      body: JSON.stringify({
        files: { [GIST_FILE]: { content: JSON.stringify(data, null, 2) } }
      })
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    setSyncStatus('synced','saved');
    setTimeout(()=>setSyncStatus('hidden',''), 2500);
  }catch(err){
    console.error('Gist save failed:',err);
    setSyncStatus('error','sync failed');
  }
}

async function loadData(){
  // Load from localStorage first for instant render
  try{const v=localStorage.getItem('iw-cards');      if(v)cards      =JSON.parse(v);}catch(e){}
  try{const v=localStorage.getItem('iw-connectors'); if(v)connectors =JSON.parse(v);}catch(e){}
  try{const v=localStorage.getItem('iw-tags');       if(v)tags        =JSON.parse(v);}catch(e){}
  try{const v=localStorage.getItem('iw-groups');    if(v)groups      =JSON.parse(v);}catch(e){}
  cards.forEach(c=>{if(!c.tags)c.tags=[];if(!c.checklist)c.checklist=[];});
  renderAll();

  // Then fetch from Gist and merge (Gist is source of truth)
  if(!isConfigured()){
    openSetup();
    return;
  }
  setSyncStatus('syncing','loading…');
  try{
    const res = await fetch('https://api.github.com/gists/'+getConfig().id, {
      headers: {'Authorization': 'token '+getConfig().token}
    });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const gist = await res.json();
    const raw  = gist.files[GIST_FILE]?.content;
    if(raw && raw.trim() !== '{}'){
      const data = JSON.parse(raw);
      // Gist is source of truth — overwrite local state
      cards      = (data.cards      || []);
      connectors = (data.connectors || []);
      tags       = (data.tags       || []);
      groups     = (data.groups     || []);
      cards.forEach(c=>{if(!c.tags)c.tags=[];if(!c.checklist)c.checklist=[];});
      // Persist locally too
      try{localStorage.setItem('iw-cards',      JSON.stringify(cards));     }catch(e){}
      try{localStorage.setItem('iw-connectors', JSON.stringify(connectors));}catch(e){}
      try{localStorage.setItem('iw-tags',       JSON.stringify(tags));      }catch(e){}
      renderAll();
    }
    setSyncStatus('synced','in sync');
    setTimeout(()=>setSyncStatus('hidden',''), 2000);
  }catch(err){
    console.error('Gist load failed:',err);
    setSyncStatus('error','sync failed — using local data');
    setTimeout(()=>setSyncStatus('hidden',''), 4000);
  }
}

// Zoom & Pan
const canvas=document.getElementById('canvas');
const canvasWrap=document.getElementById('canvas-wrap');
function applyTransform(){
  const z=ZOOM_LEVELS[zoomIndex];
  canvas.style.transform=`translate(calc(-50% + ${panX}px), calc(-50% + ${panY}px)) scale(${z})`;
  document.getElementById('zoom-label').textContent=ZOOM_LABELS[zoomIndex];
  document.querySelectorAll('.zoom-pip').forEach((p,i)=>p.classList.toggle('active',i===zoomIndex));
  drawMinimap();
}
document.getElementById('btn-zoom-in').onclick=()=>{if(zoomIndex<4){zoomIndex++;applyTransform();}};
document.getElementById('btn-zoom-out').onclick=()=>{if(zoomIndex>0){zoomIndex--;applyTransform();}};
document.querySelectorAll('.zoom-pip').forEach(p=>p.onclick=()=>{zoomIndex=+p.dataset.level;applyTransform();});
canvasWrap.addEventListener('wheel',e=>{
  e.preventDefault();
  if(e.deltaY<0&&zoomIndex<4){zoomIndex++;applyTransform();}
  else if(e.deltaY>0&&zoomIndex>0){zoomIndex--;applyTransform();}
},{passive:false});
canvasWrap.addEventListener('mousedown',e=>{
  if(connectMode)return;
  if(e.target.closest('.idea-card')||e.target.closest('#zoom-controls'))return;
  isPanning=true;panSX=e.clientX;panSY=e.clientY;panOX=panX;panOY=panY;
  canvasWrap.classList.add('panning');
});
window.addEventListener('mousemove',e=>{
  if(!isPanning)return;
  panX=panOX+(e.clientX-panSX);panY=panOY+(e.clientY-panSY);
  applyTransform(); drawMinimap();
});
window.addEventListener('mouseup',()=>{isPanning=false;canvasWrap.classList.remove('panning');});

// Cards
const rnd=arr=>arr[Math.floor(Math.random()*arr.length)];
const esc=s=>(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
const autoH=ta=>{ta.style.height='auto';ta.style.height=ta.scrollHeight+'px';};

function addCard(type,title,body,fromMobile){
  type=type||'idea';title=title||'';body=body||'';
  const sc=200;
  // Mobile-captured cards use grid layout; desktop drops freely
  let cardX, cardY;
  if(fromMobile){
    const GRID_ORIGIN_X=60, GRID_ORIGIN_Y=40;
    const CELL_W=250, CELL_H=200, COLS=4;
    const mobileCards = cards.filter(c=>c.fromMobile);
    const idx = mobileCards.length;
    cardX = GRID_ORIGIN_X + (idx % COLS) * CELL_W;
    cardY = GRID_ORIGIN_Y + Math.floor(idx / COLS) * CELL_H;
  } else {
    cardX = CX-110+(Math.random()*sc-sc/2);
    cardY = CY-70+(Math.random()*sc-sc/2);
  }
  const card={
    id:Date.now()+Math.random(),type,title,body,
    x:cardX, y:cardY,
    rotation:rnd(ROTATIONS),
    date:new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'}),
    zIndex:cards.length+10,tags:[],checklist:[],fromMobile:!!fromMobile
  };
  cards.push(card);save();updateMeta();
  return createCardEl(card);
}

function createCardEl(card){
  const el=document.createElement('div');
  el.className='idea-card card-'+card.type;
  el.dataset.id=card.id;
  el.style.cssText='left:'+card.x+'px;top:'+card.y+'px;transform:rotate('+card.rotation+'deg);z-index:'+(card.zIndex||10);
  el.innerHTML=
    '<div class="card-type-label">'+card.type+'</div>'+
    '<textarea class="card-title" placeholder="title…" spellcheck="false">'+esc(card.title)+'</textarea>'+
    '<textarea class="card-body" placeholder="expand…" spellcheck="false">'+esc(card.body)+'</textarea>'+
    '<div class="card-tags"></div>'+
    '<div class="card-checklist" id="cl-'+card.id+'"></div>'+
    '<div class="card-footer">'+
      '<span class="card-date">'+card.date+'</span>'+
      '<div class="card-actions">'+
        '<button class="card-btn tag-btn" title="Tags"><svg viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg></button>'+
        '<button class="card-btn del" title="Delete"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>'+
      '</div>'+
    '</div>';
  el.querySelectorAll('textarea').forEach(ta=>{
    autoH(ta);
    ta.addEventListener('input',()=>{autoH(ta);syncCard(card.id,el);});
    ta.addEventListener('mousedown',e=>e.stopPropagation());
  });
  el.querySelector('.del').addEventListener('click',e=>{e.stopPropagation();deleteCard(card.id,el);});
  el.querySelector('.tag-btn').addEventListener('click',e=>{e.stopPropagation();openTagPopover(card.id,el.querySelector('.tag-btn'));});
  makeDraggable(el,card);
  el.addEventListener('mousedown',()=>{if(!connectMode)toFront(card,el);});
  el.addEventListener('click',e=>cardClick(e,card,el));
  renderTagPills(card,el);
  canvas.appendChild(el);
  if(card.type==='note') renderChecklist(card,el);
  return el;
}

function renderTagPills(card,el){
  const row=el.querySelector('.card-tags');
  row.innerHTML='';
  (card.tags||[]).forEach(tag=>{
    const pill=document.createElement('span');
    pill.className='tag-pill';pill.textContent=tag;
    row.appendChild(pill);
  });
}

function syncCard(id,el){
  const c=cards.find(c=>c.id==id);if(!c)return;
  c.title=el.querySelector('.card-title').value;
  c.body=el.querySelector('.card-body').value;
  save();
}

function deleteCard(id,el){
  connectors=connectors.filter(cn=>cn.from!=id&&cn.to!=id);
  cards=cards.filter(c=>c.id!=id);
  el.style.transition='all .2s ease';el.style.opacity='0';el.style.transform+=' scale(0)';
  setTimeout(()=>{el.remove();drawConnectors();},200);
  save();updateMeta();
}

function toFront(card,el){
  const mx=Math.max(...cards.map(c=>c.zIndex||10),10);
  card.zIndex=mx+1;el.style.zIndex=card.zIndex;save();
}

function makeDraggable(el,card){
  let on=false,sx,sy,cx,cy;
  el.addEventListener('mousedown',e=>{
    if(connectMode||e.target.tagName==='TEXTAREA'||e.target.tagName==='BUTTON')return;
    e.preventDefault();e.stopPropagation();
    on=true;sx=e.clientX;sy=e.clientY;cx=card.x;cy=card.y;
    el.classList.add('dragging');canvasWrap.classList.add('card-dragging');
    toFront(card,el);closeTagPopover();
  });
  window.addEventListener('mousemove',e=>{
    if(!on)return;
    const z=ZOOM_LEVELS[zoomIndex];
    card.x=cx+(e.clientX-sx)/z;card.y=cy+(e.clientY-sy)/z;
    el.style.left=card.x+'px';el.style.top=card.y+'px';
    drawConnectors();closeTagPopover();
  });
  window.addEventListener('mouseup',()=>{
    if(!on)return;on=false;
    el.classList.remove('dragging');canvasWrap.classList.remove('card-dragging');
    el.style.transform='rotate('+card.rotation+'deg)';save();
  });
}


// Checklist (note cards only)
function renderChecklist(card,el){
  const container=el.querySelector('.card-checklist');
  if(!container)return;
  container.innerHTML='';
  (card.checklist||[]).forEach((item,idx)=>{
    container.appendChild(makeChecklistItemEl(card,idx));
  });
  // Add-item row
  const addRow=document.createElement('div');
  addRow.className='checklist-add-row';
  const addBtn=document.createElement('button');
  addBtn.className='checklist-add-btn';
  addBtn.textContent='+ add item';
  addBtn.addEventListener('mousedown',e=>e.stopPropagation());
  addBtn.addEventListener('click',e=>{
    e.stopPropagation();
    if(!card.checklist)card.checklist=[];
    card.checklist.push({text:'',done:false});
    save();
    renderChecklist(card,el);
    // focus the new item
    const items=container.querySelectorAll('.checklist-item-text');
    if(items.length) items[items.length-1].focus();
  });
  addRow.appendChild(addBtn);
  container.appendChild(addRow);
}

function makeChecklistItemEl(card,idx){
  const item=card.checklist[idx];
  const row=document.createElement('div');
  row.className='checklist-item'+(item.done?' done':'');
  
  const cb=document.createElement('input');
  cb.type='checkbox';
  cb.checked=item.done;
  cb.addEventListener('mousedown',e=>e.stopPropagation());
  cb.addEventListener('change',()=>{
    item.done=cb.checked;
    row.classList.toggle('done',item.done);
    save();
  });

  const txt=document.createElement('textarea');
  txt.className='checklist-item-text';
  txt.value=item.text;
  txt.rows=1;
  txt.placeholder='item…';
  txt.spellcheck=false;
  txt.style.height='1.45em';  // safe default before DOM insertion
  txt.addEventListener('mousedown',e=>e.stopPropagation());
  // re-measure once it's actually in the DOM
  requestAnimationFrame(()=>autoH(txt));
  txt.addEventListener('input',()=>{
    autoH(txt);
    item.text=txt.value;
    save();
  });
  txt.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&!e.shiftKey){
      e.preventDefault();
      // insert new item after this one
      card.checklist.splice(idx+1,0,{text:'',done:false});
      save();
      const cardEl=canvas.querySelector('.idea-card[data-id="'+card.id+'"]');
      if(cardEl){
        renderChecklist(card,cardEl);
        const items=cardEl.querySelectorAll('.checklist-item-text');
        if(items[idx+1]) items[idx+1].focus();
      }
    }
    if(e.key==='Backspace'&&txt.value===''){
      e.preventDefault();
      card.checklist.splice(idx,1);
      save();
      const cardEl=canvas.querySelector('.idea-card[data-id="'+card.id+'"]');
      if(cardEl){
        renderChecklist(card,cardEl);
        const items=cardEl.querySelectorAll('.checklist-item-text');
        const focusIdx=Math.max(0,idx-1);
        if(items[focusIdx]) items[focusIdx].focus();
      }
    }
  });

  row.appendChild(cb);
  row.appendChild(txt);
  return row;
}


// ═══════════════════════════════════════
// LINK CARDS
// ═══════════════════════════════════════
const linkPopover = document.getElementById('link-popover');
let linkPopoverOpen = false;

function openLinkPopover(){
  if(linkPopoverOpen){ closeLinkPopover(); return; }
  linkPopoverOpen = true;
  document.getElementById('lp-url').value   = '';
  document.getElementById('lp-title').value = '';
  document.getElementById('lp-image').value = '';
  linkPopover.classList.add('open');
  // Position below the button
  const btn  = document.getElementById('btn-add-link');
  const rect = btn.getBoundingClientRect();
  const pw   = linkPopover.offsetWidth || 280;
  let left = rect.right - pw;
  let top  = rect.bottom + 8;
  if(left < 8) left = 8;
  linkPopover.style.left = left + 'px';
  linkPopover.style.top  = top  + 'px';
  setTimeout(()=>document.getElementById('lp-url').focus(), 50);
}

function closeLinkPopover(){
  linkPopoverOpen = false;
  linkPopover.classList.remove('open');
  document.getElementById('btn-add-link').classList.remove('active');
}

document.getElementById('btn-add-link').addEventListener('click', ()=>{
  document.getElementById('btn-add-link').classList.toggle('active', !linkPopoverOpen);
  openLinkPopover();
});

linkPopover.querySelector('.lp-cancel').addEventListener('click', closeLinkPopover);

linkPopover.querySelector('.lp-add').addEventListener('click', ()=>{
  const url   = document.getElementById('lp-url').value.trim();
  const title = document.getElementById('lp-title').value.trim();
  const image = document.getElementById('lp-image').value.trim();
  if(!url){ document.getElementById('lp-url').focus(); return; }
  addLinkCard(url, title || extractDomain(url), image);
  closeLinkPopover();
});

// Submit on Enter in last field
document.getElementById('lp-image').addEventListener('keydown', e=>{
  if(e.key === 'Enter') linkPopover.querySelector('.lp-add').click();
});
document.getElementById('lp-title').addEventListener('keydown', e=>{
  if(e.key === 'Enter') document.getElementById('lp-image').focus();
});
document.getElementById('lp-url').addEventListener('keydown', e=>{
  if(e.key === 'Enter') document.getElementById('lp-title').focus();
});

// Close on outside click
document.addEventListener('click', e=>{
  if(!linkPopoverOpen) return;
  if(!linkPopover.contains(e.target) && e.target.id !== 'btn-add-link')
    closeLinkPopover();
});

function extractDomain(url){
  try{ return new URL(url).hostname.replace(/^www\./, ''); }
  catch(e){ return url; }
}

function addLinkCard(url, title, imageUrl){
  const sc = 200;
  const card = {
    id:       Date.now() + Math.random(),
    type:     'link',
    url,
    title:    title || extractDomain(url),
    imageUrl: imageUrl || '',
    body:     '',
    x:        CX - 110 + (Math.random() * sc - sc/2),
    y:        CY - 70  + (Math.random() * sc - sc/2),
    rotation: rnd(ROTATIONS),
    date:     new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'}),
    zIndex:   cards.length + 10,
    tags:     []
  };
  cards.push(card); save(); updateMeta();
  return createLinkCardEl(card);
}

function createLinkCardEl(card){
  const a = document.createElement('a');
  a.className = 'idea-card card-link-type';
  a.dataset.id = card.id;
  a.href   = card.url;
  a.target = '_blank';
  a.rel    = 'noopener noreferrer';
  a.style.cssText = 'left:'+card.x+'px;top:'+card.y+'px;transform:rotate('+card.rotation+'deg);z-index:'+(card.zIndex||10);

  const domain = extractDomain(card.url);

  a.innerHTML =
    '<div class="card-link-type-label">link</div>' +
    (card.imageUrl
      ? '<div class="card-link-preview"><img src="'+card.imageUrl+'" alt="" loading="lazy"></div>'
      : '<div class="card-link-preview"><div class="card-link-preview-placeholder"><svg viewBox="0 0 24 24"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>'+domain+'</div></div>') +
    '<div class="card-link-title">'+esc(card.title)+'</div>' +
    '<div class="card-link-domain">'+domain+'</div>' +
    '<div class="card-footer" style="margin-top:.5rem">'+
      '<span class="card-date">'+card.date+'</span>'+
      '<div class="card-actions">'+
        '<button class="card-btn del" title="Delete"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>'+
      '</div>'+
    '</div>';

  a.querySelector('.del').addEventListener('click', e=>{
    e.preventDefault(); e.stopPropagation(); deleteCard(card.id, a);
  });

  makeDraggable(a, card);
  a.addEventListener('mousedown', ()=>{ if(!connectMode) toFront(card, a); });

  // Suppress link navigation if the card was dragged (moved > 4px)
  let _linkMdX, _linkMdY;
  a.addEventListener('mousedown', e=>{ _linkMdX = e.clientX; _linkMdY = e.clientY; });
  a.addEventListener('click', e=>{
    const moved = Math.abs(e.clientX - _linkMdX) > 4 || Math.abs(e.clientY - _linkMdY) > 4;
    if(moved){ e.preventDefault(); return; }
    cardClick(e, card, a);
  });

  canvas.appendChild(a);
  return a;
}

function renderLinkCard(card){
  // used by renderAll for link-type cards
  return createLinkCardEl(card);
}

// Tag Manager
document.getElementById('btn-tags').onclick=openTagManager;
document.getElementById('tm-close').onclick=closeTagManager;
document.getElementById('tag-manager').addEventListener('click',e=>{
  if(e.target===document.getElementById('tag-manager'))closeTagManager();
});
document.getElementById('tm-add-btn').onclick=addTagFromInput;
document.getElementById('tm-input').addEventListener('keydown',e=>{if(e.key==='Enter')addTagFromInput();});

function openTagManager(){
  renderTagManager();
  document.getElementById('tag-manager').classList.add('open');
  setTimeout(()=>document.getElementById('tm-input').focus(),50);
}
function closeTagManager(){document.getElementById('tag-manager').classList.remove('open');}

function renderTagManager(){
  const list=document.getElementById('tm-list');
  list.innerHTML='';
  if(tags.length===0){list.innerHTML='<div class="tm-empty">no tags yet</div>';return;}
  tags.forEach(tag=>{
    const row=document.createElement('div');
    row.className='tm-tag-row';
    row.innerHTML='<span class="tm-tag-name">'+esc(tag)+'</span><button class="tm-del-tag">×</button>';
    row.querySelector('.tm-del-tag').onclick=()=>deleteTag(tag);
    list.appendChild(row);
  });
}

function addTagFromInput(){
  const input=document.getElementById('tm-input');
  const val=input.value.trim().toLowerCase();
  if(!val)return;
  if(tags.includes(val)){showToast('tag already exists');return;}
  tags.push(val);save();input.value='';renderTagManager();
}

function deleteTag(tag){
  tags=tags.filter(t=>t!==tag);
  cards.forEach(c=>{c.tags=(c.tags||[]).filter(t=>t!==tag);});
  save();renderTagManager();
  canvas.querySelectorAll('.idea-card').forEach(el=>{
    const card=cards.find(c=>c.id==el.dataset.id);
    if(card)renderTagPills(card,el);
  });
}

// Tag Popover
const tagPopover=document.getElementById('tag-popover');

function openTagPopover(cardId,anchorEl){
  if(popoverCardId===cardId){closeTagPopover();return;}
  popoverCardId=cardId;
  const card=cards.find(c=>c.id==cardId);if(!card)return;
  const list=document.getElementById('tag-popover-list');
  list.innerHTML='';
  if(tags.length===0){
    list.innerHTML='<div class="tag-popover-empty">no tags yet — use the tag icon in the toolbar first</div>';
  }else{
    tags.forEach(tag=>{
      const on=(card.tags||[]).includes(tag);
      const row=document.createElement('div');
      row.className='tag-option';
      row.innerHTML='<div class="tag-check '+(on?'on':'')+'"></div><span class="tag-option-label">'+esc(tag)+'</span>';
      row.addEventListener('click',e=>{
        e.stopPropagation();
        toggleCardTag(cardId,tag);
        const nowOn=(cards.find(c=>c.id==cardId).tags||[]).includes(tag);
        row.querySelector('.tag-check').classList.toggle('on',nowOn);
      });
      list.appendChild(row);
    });
  }
  tagPopover.classList.add('open');
  requestAnimationFrame(()=>{
    const rect=anchorEl.getBoundingClientRect();
    const pw=tagPopover.offsetWidth,ph=tagPopover.offsetHeight;
    let left=rect.right-pw,top=rect.top-ph-6;
    if(left<8)left=8;
    if(top<8)top=rect.bottom+6;
    tagPopover.style.left=left+'px';tagPopover.style.top=top+'px';
  });
}

function closeTagPopover(){tagPopover.classList.remove('open');popoverCardId=null;}

function toggleCardTag(cardId,tag){
  const card=cards.find(c=>c.id==cardId);if(!card)return;
  if(!card.tags)card.tags=[];
  const idx=card.tags.indexOf(tag);
  if(idx===-1)card.tags.push(tag);else card.tags.splice(idx,1);
  save();
  const el=canvas.querySelector('.idea-card[data-id="'+cardId+'"]');
  if(el)renderTagPills(card,el);
}

document.addEventListener('click',e=>{
  if(popoverCardId===null)return;
  if(!tagPopover.contains(e.target)&&!e.target.closest('.tag-btn'))closeTagPopover();
});

// Connect Mode
const btnConnect=document.getElementById('btn-connect');
btnConnect.addEventListener('click',toggleConnect);

document.addEventListener('keydown',e=>{
  if(document.body.classList.contains('capture-mode'))return;
  if(document.getElementById('tag-manager').classList.contains('open'))return;
  if(e.target.matches('textarea,input'))return;
  if(e.key==='Escape'){exitConnect();closeTagManager();closeTagPopover();}
  if(e.key==='c'||e.key==='C')toggleConnect();
  if(e.key==='t'||e.key==='T')openTagManager();
  if((e.key==='n'||e.key==='N')&&!connectMode){
    const el=addCard('idea');setTimeout(()=>el.querySelector('.card-title').focus(),50);
  }
});

function toggleConnect(){connectMode?exitConnect():enterConnect();}
function enterConnect(){
  connectMode=true;connectFirst=null;
  document.body.classList.add('connect-mode');btnConnect.classList.add('active');
  closeTagPopover();
}
function exitConnect(){
  connectMode=false;connectFirst=null;
  document.body.classList.remove('connect-mode');btnConnect.classList.remove('active');
  document.querySelectorAll('.idea-card.connect-sel').forEach(el=>el.classList.remove('connect-sel'));
  document.getElementById('preview-line').setAttribute('display','none');
  document.getElementById('preview-dot').setAttribute('display','none');
}

function cardClick(e,card,el){
  if(!connectMode)return;
  e.stopPropagation();
  if(connectFirst===null){connectFirst=card.id;el.classList.add('connect-sel');}
  else if(connectFirst===card.id){el.classList.remove('connect-sel');connectFirst=null;}
  else{
    const a=connectFirst,b=card.id;
    const dupe=connectors.some(cn=>(cn.from==a&&cn.to==b)||(cn.from==b&&cn.to==a));
    if(!dupe){connectors.push({id:Date.now()+Math.random(),from:a,to:b});save();drawConnectors();showToast('cards connected ✦');}
    else showToast('already connected');
    document.querySelectorAll('.idea-card.connect-sel').forEach(el=>el.classList.remove('connect-sel'));
    connectFirst=null;
  }
}

canvasWrap.addEventListener('mousemove',e=>{
  if(!connectMode||connectFirst===null)return;
  const fc=cards.find(c=>c.id==connectFirst);if(!fc)return;
  const z=ZOOM_LEVELS[zoomIndex];
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)/z,my=(e.clientY-rect.top)/z;
  const w=fc.type==='note'?92:110,h=fc.type==='note'?54:70;
  const pl=document.getElementById('preview-line'),pd=document.getElementById('preview-dot');
  pl.setAttribute('display','');pl.setAttribute('x1',fc.x+w);pl.setAttribute('y1',fc.y+h);pl.setAttribute('x2',mx);pl.setAttribute('y2',my);
  pd.setAttribute('display','');pd.setAttribute('cx',fc.x+w);pd.setAttribute('cy',fc.y+h);
});
canvasWrap.addEventListener('mouseleave',()=>{
  document.getElementById('preview-line').setAttribute('display','none');
  document.getElementById('preview-dot').setAttribute('display','none');
});

// Connectors
function cardCenter(id){
  const c=cards.find(c=>c.id==id);if(!c)return null;
  const w=c.type==='note'?92:110,h=c.type==='note'?54:70;
  return{x:c.x+w,y:c.y+h};
}
function drawConnectors(){
  document.querySelectorAll('.conn-g').forEach(el=>el.remove());
  const svg=document.getElementById('connector-svg');
  connectors.forEach(cn=>{
    const a=cardCenter(cn.from),b=cardCenter(cn.to);if(!a||!b)return;
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    g.classList.add('conn-g');
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.classList.add('conn-line');
    line.setAttribute('x1',a.x);line.setAttribute('y1',a.y);line.setAttribute('x2',b.x);line.setAttribute('y2',b.y);
    const dA=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dA.classList.add('conn-dot');dA.setAttribute('cx',a.x);dA.setAttribute('cy',a.y);dA.setAttribute('r','3.5');
    const dB=document.createElementNS('http://www.w3.org/2000/svg','circle');
    dB.classList.add('conn-dot');dB.setAttribute('cx',b.x);dB.setAttribute('cy',b.y);dB.setAttribute('r','3.5');
    const hit=document.createElementNS('http://www.w3.org/2000/svg','line');
    hit.classList.add('conn-hit');
    hit.setAttribute('x1',a.x);hit.setAttribute('y1',a.y);hit.setAttribute('x2',b.x);hit.setAttribute('y2',b.y);
    hit.addEventListener('click',e=>{e.stopPropagation();connectors=connectors.filter(c=>c.id!=cn.id);save();drawConnectors();showToast('connection removed');});
    g.append(line,dA,dB,hit);
    svg.insertBefore(g,svg.firstChild);
  });
}


// ═══════════════════════════════════════
// GROUPS
// ═══════════════════════════════════════
const DFLT_GW = 320, DFLT_GH = 260;

document.getElementById('btn-add-group').addEventListener('click', ()=>{
  if(connectMode) exitConnect();
  // Place in current viewport center
  const z = ZOOM_LEVELS[zoomIndex];
  const vw = window.innerWidth, vh = window.innerHeight;
  const cx = -panX/z + 2000 - DFLT_GW/2;
  const cy = -panY/z + 1500 - DFLT_GH/2;
  const g = {
    id: Date.now()+Math.random(),
    x: cx, y: cy, w: DFLT_GW, h: DFLT_GH,
    label: 'group'
  };
  groups.push(g); save();
  const el = createGroupEl(g);
  // Focus label for immediate rename
  setTimeout(()=>el.querySelector('.group-label').focus(), 80);
});

function createGroupEl(g){
  const el = document.createElement('div');
  el.className = 'group-box';
  el.dataset.id = g.id;
  el.style.cssText = 'left:'+g.x+'px;top:'+g.y+'px;width:'+g.w+'px;height:'+g.h+'px';

  // Label
  const label = document.createElement('input');
  label.type = 'text'; label.className = 'group-label';
  label.value = g.label; label.maxLength = 32;
  label.spellcheck = false;
  label.addEventListener('mousedown', e=>e.stopPropagation());
  label.addEventListener('input', ()=>{ g.label=label.value; save(); });
  label.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key==='Escape') label.blur(); });

  // Delete button
  const del = document.createElement('button');
  del.className = 'group-del'; del.title = 'Delete group';
  del.innerHTML = '<svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
  del.addEventListener('mousedown', e=>e.stopPropagation());
  del.addEventListener('click', e=>{ e.stopPropagation(); deleteGroup(g.id, el); });

  // Resize handle
  const rsz = document.createElement('div');
  rsz.className = 'group-resize';
  rsz.innerHTML = '<svg viewBox="0 0 10 10"><line x1="9" y1="1" x2="1" y2="9"/><line x1="9" y1="5" x2="5" y2="9"/></svg>';

  el.appendChild(label); el.appendChild(del); el.appendChild(rsz);

  // Drag to move
  makeGroupDraggable(el, g);

  // Resize
  let rOn=false, rSX, rSY, rOW, rOH;
  rsz.addEventListener('mousedown', e=>{
    e.preventDefault(); e.stopPropagation();
    rOn=true; rSX=e.clientX; rSY=e.clientY; rOW=g.w; rOH=g.h;
  });
  window.addEventListener('mousemove', e=>{
    if(!rOn) return;
    const z=ZOOM_LEVELS[zoomIndex];
    g.w = Math.max(120, rOW+(e.clientX-rSX)/z);
    g.h = Math.max(80,  rOH+(e.clientY-rSY)/z);
    el.style.width=g.w+'px'; el.style.height=g.h+'px';
    drawMinimap();
  });
  window.addEventListener('mouseup', ()=>{ if(rOn){rOn=false;save();} });

  // Insert behind cards (at start of canvas)
  canvas.insertBefore(el, canvas.firstChild);
  return el;
}

function makeGroupDraggable(el, g){
  let on=false, sx, sy, ox, oy;
  el.addEventListener('mousedown', e=>{
    if(e.target.classList.contains('group-label')) return;
    if(e.target.classList.contains('group-del')) return;
    if(e.target.closest('.group-resize')) return;
    e.preventDefault();
    on=true; sx=e.clientX; sy=e.clientY; ox=g.x; oy=g.y;
    canvasWrap.classList.add('card-dragging');
  });
  window.addEventListener('mousemove', e=>{
    if(!on) return;
    const z=ZOOM_LEVELS[zoomIndex];
    g.x=ox+(e.clientX-sx)/z; g.y=oy+(e.clientY-sy)/z;
    el.style.left=g.x+'px'; el.style.top=g.y+'px';
    drawMinimap();
  });
  window.addEventListener('mouseup', ()=>{ if(on){on=false;canvasWrap.classList.remove('card-dragging');save();} });
}

function deleteGroup(id, el){
  groups = groups.filter(g=>g.id!=id);
  el.style.transition='all .2s ease'; el.style.opacity='0';
  setTimeout(()=>el.remove(), 200);
  save(); drawMinimap();
}

function renderGroups(){
  canvas.querySelectorAll('.group-box').forEach(e=>e.remove());
  groups.forEach(g=>createGroupEl(g));
}

// ═══════════════════════════════════════
// MINIMAP
// ═══════════════════════════════════════
const CMAP_W=4000, CMAP_H=3000;
const mmEl = document.getElementById('minimap');
const mmCanvas = document.getElementById('minimap-canvas');
const mmCtx = mmCanvas.getContext('2d');
let mmDragging=false;

// Retina-sharp canvas
function initMinimap(){
  const dpr = window.devicePixelRatio||1;
  mmCanvas.width  = 168*dpr; mmCanvas.height = 112*dpr;
  mmCanvas.style.width='168px'; mmCanvas.style.height='112px';
  mmCtx.scale(dpr,dpr);
}

function drawMinimap(){
  const W=168, H=112;
  const scaleX=W/CMAP_W, scaleY=H/CMAP_H;
  mmCtx.clearRect(0,0,W,H);

  // Background
  mmCtx.fillStyle='rgba(245,240,232,0.0)';
  mmCtx.fillRect(0,0,W,H);

  // Groups
  groups.forEach(g=>{
    mmCtx.fillStyle='rgba(30,20,10,.04)';
    mmCtx.strokeStyle='rgba(30,20,10,.2)';
    mmCtx.lineWidth=0.5;
    mmCtx.beginPath();
    mmCtx.rect(g.x*scaleX, g.y*scaleY, g.w*scaleX, g.h*scaleY);
    mmCtx.fill(); mmCtx.stroke();
  });

  // Cards — dots
  cards.forEach(c=>{
    const cx=(c.x+110)*scaleX, cy=(c.y+70)*scaleY;
    mmCtx.fillStyle = c.type==='note' ? 'rgba(70,100,200,.5)' :
                      c.type==='link' ? 'rgba(200,75,47,.5)' :
                      'rgba(30,20,10,.4)';
    mmCtx.beginPath();
    mmCtx.arc(cx,cy,2.5,0,Math.PI*2);
    mmCtx.fill();
  });

  // Viewport rectangle
  const z = ZOOM_LEVELS[zoomIndex];
  const vw=window.innerWidth, vh=window.innerHeight;
  // canvas origin in canvas-space coords
  const vpX = (CMAP_W/2) - vw/(2*z) - panX/z;
  const vpY = (CMAP_H/2) - vh/(2*z) - panY/z;
  const vpW = vw/z, vpH = vh/z;
  mmCtx.strokeStyle='rgba(200,75,47,.7)';
  mmCtx.lineWidth=1;
  mmCtx.strokeRect(vpX*scaleX, vpY*scaleY, vpW*scaleX, vpH*scaleY);
}

// Click/drag minimap to navigate
function mmEventToCanvas(e){
  const rect=mmEl.getBoundingClientRect();
  const mx=(e.clientX-rect.left)/168*CMAP_W;
  const my=(e.clientY-rect.top)/112*CMAP_H;
  return{mx,my};
}
function jumpToMinimap(e){
  const{mx,my}=mmEventToCanvas(e);
  const z=ZOOM_LEVELS[zoomIndex];
  const vw=window.innerWidth,vh=window.innerHeight;
  panX = (CMAP_W/2 - mx)*z + vw/2 - vw/2;
  panY = (CMAP_H/2 - my)*z + vh/2 - vh/2;
  // simpler: center viewport on clicked point
  panX = -(mx - CMAP_W/2)*z;
  panY = -(my - CMAP_H/2)*z;
  applyTransform(); drawMinimap();
}
mmEl.addEventListener('mousedown', e=>{ mmDragging=true; jumpToMinimap(e); e.stopPropagation(); });
window.addEventListener('mousemove', e=>{ if(mmDragging) jumpToMinimap(e); });
window.addEventListener('mouseup', ()=>{ mmDragging=false; });

// Minimap toggle
document.getElementById('minimap-toggle').addEventListener('click', ()=>{
  document.body.classList.remove('minimap-hidden');
  drawMinimap();
});
mmEl.addEventListener('dblclick', ()=>{ document.body.classList.add('minimap-hidden'); });

// Redraw minimap on pan/zoom
const _origApply = applyTransform;

// Render
function renderAll(){
  canvas.querySelectorAll('.idea-card').forEach(e=>e.remove());
  cards.forEach(c=>{ if(c.type==='link') createLinkCardEl(c); else createCardEl(c); });
  const idSet=new Set(cards.map(c=>c.id));
  connectors=connectors.filter(cn=>idSet.has(cn.from)&&idSet.has(cn.to));
  drawConnectors(); renderGroups(); updateMeta(); applyTransform();
}
function updateMeta(){
  document.getElementById('empty-state').classList.toggle('hidden',cards.length>0);
  const n=cards.length;
  document.getElementById('card-count').textContent=n>0?n+' card'+(n!==1?'s':''):'';
}

// Buttons
document.getElementById('btn-add').onclick=()=>{
  if(connectMode)exitConnect();
  const el=addCard('idea');setTimeout(()=>el.querySelector('.card-title').focus(),50);
};
document.getElementById('btn-add-note').onclick=()=>{
  if(connectMode)exitConnect();
  const el=addCard('note');setTimeout(()=>el.querySelector('.card-title').focus(),50);
};

// Capture (#capture hash)
function checkHash(){
  if(location.hash==='#capture'){
    document.body.classList.add('capture-mode');
    setTimeout(()=>document.getElementById('cap-title').focus(),120);
  }else{
    document.body.classList.remove('capture-mode');
  }
}
window.addEventListener('hashchange',checkHash);
function goWall(){
  history.pushState('',document.title,location.pathname+location.search);
  document.body.classList.remove('capture-mode');
}
document.getElementById('btn-cancel-capture').onclick=goWall;
document.getElementById('btn-submit-capture').onclick=()=>{
  const title=document.getElementById('cap-title').value.trim();
  const body=document.getElementById('cap-body').value.trim();
  if(!title&&!body){showCaptureFeedback('add a title or note first','error');return;}
  addCard('idea',title,body,true);
  document.getElementById('cap-title').value='';
  document.getElementById('cap-body').value='';
  showCaptureFeedback('idea added to wall ✦','success');
  setTimeout(()=>document.getElementById('cap-title').focus(),300);
};

function showCaptureFeedback(msg, type){
  const fb=document.getElementById('capture-feedback');
  fb.textContent=msg;
  fb.className='capture-feedback show '+(type||'');
  clearTimeout(fb._t);
  fb._t=setTimeout(()=>fb.classList.remove('show'),2800);
}
document.getElementById('cap-title').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();document.getElementById('cap-body').focus();}
});

// Toast
let toastT;
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg;t.classList.add('show');
  clearTimeout(toastT);toastT=setTimeout(()=>t.classList.remove('show'),2200);
}



// Setup modal
function openSetup(){
  // Pre-fill if already set (e.g. editing)
  const c = getConfig();
  document.getElementById('setup-gist-id').value    = c.id;
  document.getElementById('setup-gist-token').value = c.token;
  document.getElementById('setup-modal').classList.add('open');
  setTimeout(()=>document.getElementById('setup-gist-id').focus(), 80);
}
function closeSetup(){
  document.getElementById('setup-modal').classList.remove('open');
}
document.getElementById('setup-save').onclick = function(){
  const id    = document.getElementById('setup-gist-id').value.trim();
  const token = document.getElementById('setup-gist-token').value.trim();
  const errEl = document.getElementById('setup-error');
  if(!id || !token){ errEl.classList.add('show'); return; }
  errEl.classList.remove('show');
  localStorage.setItem('iw-gist-id',    id);
  localStorage.setItem('iw-gist-token', token);
  closeSetup();
  // Trigger a fresh load from Gist now that we have credentials
  loadData();
};
document.getElementById('setup-skip').onclick = closeSetup;
document.getElementById('btn-setup').onclick = openSetup;
// Close on backdrop click
document.getElementById('setup-modal').addEventListener('click', function(e){
  if(e.target === this) closeSetup();
});
// Allow Enter key in token field to save
document.getElementById('setup-gist-token').addEventListener('keydown', e=>{
  if(e.key==='Enter') document.getElementById('setup-save').click();
});

// Init
initMinimap(); loadData().then(checkHash);
</script>

</body>
</html>