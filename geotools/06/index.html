<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Timeline JSON Editor</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef } = React;

        const Upload = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const Download = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const Filter = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
            </svg>
        );

        const FileText = ({ size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
        );

        function TimelineJSONEditor() {
            const [jsonData, setJsonData] = useState(null);
            const [originalFileName, setOriginalFileName] = useState('');
            const [stats, setStats] = useState(null);
            const [filters, setFilters] = useState({
                startDate: '',
                endDate: '',
                minLat: '',
                maxLat: '',
                minLng: '',
                maxLng: ''
            });
            const fileInputRef = useRef(null);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                setOriginalFileName(file.name);
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        setJsonData(data);
                        analyzeData(data);
                    } catch (error) {
                        alert('Error parsing JSON: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };

            const analyzeData = (data) => {
                const items = Array.isArray(data) ? data : (data.timelineObjects || data.locations || []);
                
                let totalItems = items.length;
                let timestamps = [];
                let lats = [];
                let lngs = [];

                items.forEach(item => {
                    // Extract timestamps
                    if (item.startTime) timestamps.push(item.startTime);
                    if (item.endTime) timestamps.push(item.endTime);
                    if (item.timestamp) timestamps.push(item.timestamp);
                    if (item.timestampMs) timestamps.push(item.timestampMs);

                    // Extract locations
                    if (item.visit?.topCandidate?.placeLocation) {
                        const coords = parseGeoString(item.visit.topCandidate.placeLocation);
                        if (coords) {
                            lats.push(coords.lat);
                            lngs.push(coords.lng);
                        }
                    }
                    if (item.activity?.start?.latLng) {
                        lats.push(item.activity.start.latLng.latitude);
                        lngs.push(item.activity.start.latLng.longitude);
                    }
                    if (item.activity?.end?.latLng) {
                        lats.push(item.activity.end.latLng.latitude);
                        lngs.push(item.activity.end.latLng.longitude);
                    }
                    if (item.location) {
                        lats.push(item.location.latitudeE7 / 1e7);
                        lngs.push(item.location.longitudeE7 / 1e7);
                    }
                    if (item.latitudeE7) {
                        lats.push(item.latitudeE7 / 1e7);
                        lngs.push(item.longitudeE7 / 1e7);
                    }
                });

                timestamps = timestamps.filter(t => t).map(t => new Date(t)).filter(d => !isNaN(d));
                timestamps.sort((a, b) => a - b);

                setStats({
                    totalItems,
                    dateRange: timestamps.length > 0 
                        ? `${timestamps[0].toLocaleDateString()} - ${timestamps[timestamps.length - 1].toLocaleDateString()}`
                        : 'Unknown',
                    minDate: timestamps.length > 0 ? timestamps[0].toISOString().split('T')[0] : '',
                    maxDate: timestamps.length > 0 ? timestamps[timestamps.length - 1].toISOString().split('T')[0] : '',
                    areaRange: lats.length > 0 
                        ? `${Math.min(...lats).toFixed(2)}¬∞, ${Math.min(...lngs).toFixed(2)}¬∞ to ${Math.max(...lats).toFixed(2)}¬∞, ${Math.max(...lngs).toFixed(2)}¬∞`
                        : 'Unknown',
                    minLat: lats.length > 0 ? Math.min(...lats).toFixed(6) : '',
                    maxLat: lats.length > 0 ? Math.max(...lats).toFixed(6) : '',
                    minLng: lngs.length > 0 ? Math.min(...lngs).toFixed(6) : '',
                    maxLng: lngs.length > 0 ? Math.max(...lngs).toFixed(6) : ''
                });

                // Auto-populate filters
                if (timestamps.length > 0) {
                    setFilters({
                        startDate: timestamps[0].toISOString().split('T')[0],
                        endDate: timestamps[timestamps.length - 1].toISOString().split('T')[0],
                        minLat: lats.length > 0 ? Math.min(...lats).toFixed(6) : '',
                        maxLat: lats.length > 0 ? Math.max(...lats).toFixed(6) : '',
                        minLng: lngs.length > 0 ? Math.min(...lngs).toFixed(6) : '',
                        maxLng: lngs.length > 0 ? Math.max(...lngs).toFixed(6) : ''
                    });
                }
            };

            const parseGeoString = (geoStr) => {
                const match = geoStr.match(/geo:([-\d.]+),([-\d.]+)/);
                if (match) {
                    return {
                        lat: parseFloat(match[1]),
                        lng: parseFloat(match[2])
                    };
                }
                return null;
            };

            const getItemTimestamp = (item) => {
                return item.startTime || item.endTime || item.timestamp || item.timestampMs;
            };

            const getItemCoords = (item) => {
                if (item.visit?.topCandidate?.placeLocation) {
                    return parseGeoString(item.visit.topCandidate.placeLocation);
                }
                if (item.activity?.start?.latLng) {
                    return { lat: item.activity.start.latLng.latitude, lng: item.activity.start.latLng.longitude };
                }
                if (item.location) {
                    return { lat: item.location.latitudeE7 / 1e7, lng: item.location.longitudeE7 / 1e7 };
                }
                if (item.latitudeE7) {
                    return { lat: item.latitudeE7 / 1e7, lng: item.longitudeE7 / 1e7 };
                }
                return null;
            };

            const applyFilters = () => {
                if (!jsonData) return;

                const items = Array.isArray(jsonData) ? jsonData : (jsonData.timelineObjects || jsonData.locations || []);
                
                const filtered = items.filter(item => {
                    // Date filter
                    const timestamp = getItemTimestamp(item);
                    if (timestamp) {
                        const date = new Date(timestamp);
                        if (!isNaN(date)) {
                            if (filters.startDate) {
                                const start = new Date(filters.startDate);
                                if (date < start) return false;
                            }
                            if (filters.endDate) {
                                const end = new Date(filters.endDate + 'T23:59:59');
                                if (date > end) return false;
                            }
                        }
                    }

                    // Area filter
                    const coords = getItemCoords(item);
                    if (coords) {
                        if (filters.minLat && coords.lat < parseFloat(filters.minLat)) return false;
                        if (filters.maxLat && coords.lat > parseFloat(filters.maxLat)) return false;
                        if (filters.minLng && coords.lng < parseFloat(filters.minLng)) return false;
                        if (filters.maxLng && coords.lng > parseFloat(filters.maxLng)) return false;
                    }

                    return true;
                });

                return filtered;
            };

            const previewFiltered = () => {
                const filtered = applyFilters();
                alert(`Filtered result will contain ${filtered.length} items out of ${stats.totalItems} total items.`);
            };

            const downloadFiltered = () => {
                const filtered = applyFilters();
                
                if (filtered.length === 0) {
                    alert('No items match the current filters!');
                    return;
                }

                // Preserve original structure
                let output;
                if (Array.isArray(jsonData)) {
                    output = filtered;
                } else if (jsonData.timelineObjects) {
                    output = { timelineObjects: filtered };
                } else if (jsonData.locations) {
                    output = { locations: filtered };
                } else {
                    output = filtered;
                }

                const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // Generate filename based on filters
                const baseName = originalFileName.replace('.json', '');
                const dateStr = filters.startDate && filters.endDate 
                    ? `_${filters.startDate}_to_${filters.endDate}`
                    : '';
                a.download = `${baseName}_filtered${dateStr}.json`;
                
                a.click();
                URL.revokeObjectURL(url);
            };

            const downloadAll = () => {
                const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = originalFileName || 'timeline_data.json';
                a.click();
                URL.revokeObjectURL(url);
            };

            const setQuickFilter = (type) => {
                if (!stats) return;

                switch(type) {
                    case 'all':
                        setFilters({
                            startDate: stats.minDate,
                            endDate: stats.maxDate,
                            minLat: stats.minLat,
                            maxLat: stats.maxLat,
                            minLng: stats.minLng,
                            maxLng: stats.maxLng
                        });
                        break;
                    case 'last-month':
                        const lastMonth = new Date();
                        lastMonth.setMonth(lastMonth.getMonth() - 1);
                        setFilters({
                            ...filters,
                            startDate: lastMonth.toISOString().split('T')[0],
                            endDate: new Date().toISOString().split('T')[0]
                        });
                        break;
                    case 'this-year':
                        const yearStart = new Date(new Date().getFullYear(), 0, 1);
                        setFilters({
                            ...filters,
                            startDate: yearStart.toISOString().split('T')[0],
                            endDate: new Date().toISOString().split('T')[0]
                        });
                        break;
                    case 'boston':
                        // Greater Boston area bounds
                        setFilters({
                            ...filters,
                            minLat: '42.200000',
                            maxLat: '42.500000',
                            minLng: '-71.200000',
                            maxLng: '-70.900000'
                        });
                        break;
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-slate-800 flex items-center gap-3">
                                        <FileText size={32} className="text-blue-500" />
                                        Google Timeline JSON Editor
                                    </h1>
                                    <p className="text-slate-600 mt-2">Filter and export your location history data</p>
                                </div>
                                <button
                                    onClick={() => fileInputRef.current?.click()}
                                    className="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors"
                                >
                                    <Upload size={20} />
                                    Upload JSON
                                </button>
                                <input
                                    ref={fileInputRef}
                                    type="file"
                                    accept=".json"
                                    onChange={handleFileUpload}
                                    className="hidden"
                                />
                            </div>

                            {stats && (
                                <div>
                                    <div className="bg-blue-50 rounded-lg p-6 mb-6">
                                        <h2 className="text-lg font-semibold text-blue-900 mb-4">File Summary</h2>
                                        <div className="grid grid-cols-3 gap-4">
                                            <div>
                                                <div className="text-sm text-blue-600 font-medium">Total Items</div>
                                                <div className="text-2xl font-bold text-slate-800">{stats.totalItems.toLocaleString()}</div>
                                            </div>
                                            <div>
                                                <div className="text-sm text-blue-600 font-medium">Date Range</div>
                                                <div className="text-sm font-semibold text-slate-800">{stats.dateRange}</div>
                                            </div>
                                            <div>
                                                <div className="text-sm text-blue-600 font-medium">Geographic Area</div>
                                                <div className="text-xs font-semibold text-slate-800">{stats.areaRange}</div>
                                            </div>
                                        </div>
                                    </div>

                                                                            <div className="bg-slate-50 rounded-lg p-6 mb-6">
                                        <div className="flex items-center justify-between mb-4">
                                            <h2 className="text-lg font-semibold text-slate-800 flex items-center gap-2">
                                                <Filter size={20} />
                                                Filters
                                            </h2>
                                            <div className="flex gap-2 flex-wrap">
                                                <button
                                                    onClick={() => setQuickFilter('all')}
                                                    className="text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded transition-colors"
                                                >
                                                    All Data
                                                </button>
                                                <button
                                                    onClick={() => setQuickFilter('last-month')}
                                                    className="text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded transition-colors"
                                                >
                                                    Last Month
                                                </button>
                                                <button
                                                    onClick={() => setQuickFilter('this-year')}
                                                    className="text-xs bg-slate-200 hover:bg-slate-300 px-3 py-1 rounded transition-colors"
                                                >
                                                    This Year
                                                </button>
                                                <button
                                                    onClick={() => setQuickFilter('boston')}
                                                    className="text-xs bg-blue-200 hover:bg-blue-300 px-3 py-1 rounded transition-colors font-medium"
                                                >
                                                    üìç Boston Area
                                                </button>
                                            </div>
                                        </div>

                                        <div className="mb-6">
                                            <h3 className="text-sm font-semibold text-slate-700 mb-3">Date Range</h3>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-600 mb-1">Start Date</label>
                                                    <input
                                                        type="date"
                                                        value={filters.startDate}
                                                        onChange={(e) => setFilters({...filters, startDate: e.target.value})}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-600 mb-1">End Date</label>
                                                    <input
                                                        type="date"
                                                        value={filters.endDate}
                                                        onChange={(e) => setFilters({...filters, endDate: e.target.value})}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="mb-6">
                                            <h3 className="text-sm font-semibold text-slate-700 mb-3">Geographic Bounds (Optional)</h3>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-600 mb-1">Min Latitude</label>
                                                    <input
                                                        type="number"
                                                        step="0.000001"
                                                        value={filters.minLat}
                                                        onChange={(e) => setFilters({...filters, minLat: e.target.value})}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-600 mb-1">Max Latitude</label>
                                                    <input
                                                        type="number"
                                                        step="0.000001"
                                                        value={filters.maxLat}
                                                        onChange={(e) => setFilters({...filters, maxLat: e.target.value})}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-600 mb-1">Min Longitude</label>
                                                    <input
                                                        type="number"
                                                        step="0.000001"
                                                        value={filters.minLng}
                                                        onChange={(e) => setFilters({...filters, minLng: e.target.value})}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-slate-600 mb-1">Max Longitude</label>
                                                    <input
                                                        type="number"
                                                        step="0.000001"
                                                        value={filters.maxLng}
                                                        onChange={(e) => setFilters({...filters, maxLng: e.target.value})}
                                                        className="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm"
                                                    />
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex gap-3">
                                            <button
                                                onClick={previewFiltered}
                                                className="flex-1 bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg transition-colors font-semibold"
                                            >
                                                Preview Filter Result
                                            </button>
                                            <button
                                                onClick={downloadFiltered}
                                                className="flex-1 flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg transition-colors font-semibold"
                                            >
                                                <Download size={20} />
                                                Download Filtered JSON
                                            </button>
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 rounded-lg p-6 border-2 border-slate-200">
                                        <h2 className="text-lg font-semibold text-slate-800 mb-3">Quick Actions</h2>
                                        <p className="text-sm text-slate-600 mb-4">Download the original file without any filtering</p>
                                        <button
                                            onClick={downloadAll}
                                            className="w-full flex items-center justify-center gap-2 bg-slate-600 hover:bg-slate-700 text-white px-6 py-3 rounded-lg transition-colors font-semibold"
                                        >
                                            <Download size={20} />
                                            Download Original JSON
                                        </button>
                                    </div>
                                </div>
                            )}

                            {!stats && (
                                <div className="bg-slate-50 rounded-lg p-12 text-center">
                                    <Upload size={48} className="mx-auto text-slate-400 mb-4" />
                                    <p className="text-slate-600 text-lg">Upload a Google Timeline JSON file to get started</p>
                                    <p className="text-slate-500 text-sm mt-2">Supports all Timeline formats</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TimelineJSONEditor />, document.getElementById('root'));
    </script>
</body>
</html>